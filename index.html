// Responde a solicitudes GET (o preflight OPTIONS, en algunos casos)
function doGet(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}

// También implementa doOptions para solicitudes preflight
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}

// Función que procesa solicitudes POST y actualiza la hoja
function doPost(e) {
  if (!e) {
    return ContentService.createTextOutput("No POST data received.");
  }
  
  try {
    var data = JSON.parse(e.postData.contents);
    var orderNumber = data.orderNumber;
    var chofer = data.chofer;
    var fechaEscaneo = new Date();
    
    // Abre la hoja de cálculo mediante su ID
    var ss = SpreadsheetApp.openById("12nAfHXvoet07ai1dNhmwwhvs1rcwfdMOtnod7ozOL7w");
    var sheet = ss.getSheetByName("Ventas");
    var rows = sheet.getDataRange().getValues();
    var headers = rows[0];
    
    var orderCol = headers.indexOf("Número de orden");
    var choferCol = headers.indexOf("Chofer");
    var fechaCol = headers.indexOf("Fecha de escaneo");
    
    if (orderCol === -1 || choferCol === -1 || fechaCol === -1) {
      throw new Error("No se encontraron una o más columnas requeridas en la hoja.");
    }
    
    var rowFound = -1;
    for (var i = 1; i < rows.length; i++) {
      if (rows[i][orderCol].toString().trim() === orderNumber.toString().trim()) {
        rowFound = i + 1;
        break;
      }
    }
    
    if (rowFound === -1) {
      throw new Error("Orden no encontrada: " + orderNumber);
    }
    
    sheet.getRange(rowFound, choferCol + 1).setValue(chofer);
    sheet.getRange(rowFound, fechaCol + 1).setValue(fechaEscaneo);
    
    var output = ContentService.createTextOutput(JSON.stringify({result: "success"}));
    output.setMimeType(ContentService.MimeType.JSON);
    output.setHeader("Access-Control-Allow-Origin", "*");
    return output;
    
  } catch (err) {
    var errorOutput = ContentService.createTextOutput(JSON.stringify({result: "error", message: err.toString()}));
    errorOutput.setMimeType(ContentService.MimeType.JSON);
    errorOutput.setHeader("Access-Control-Allow-Origin", "*");
    return errorOutput;
  }
}
